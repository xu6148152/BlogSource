<!doctype html>



  


<html class="theme-next muse use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="RxJava使用观察者模式，基于事件驱动。主要包含两部分Observable和Observaber。而Rxjava最大的特色在于其灵活强大的操作符(Operators)和调度器(Scheduler)
OperatorsCreating Observablescreate(OnSubscribe)
示例

123456789101112131415Observable.create(subscrib">
<meta property="og:type" content="article">
<meta property="og:title" content="深入理解RxJava">
<meta property="og:url" content="http://xu6148152.github.io/2017/01/01/深入理解RxJava/index.html">
<meta property="og:site_name" content="Blog">
<meta property="og:description" content="RxJava使用观察者模式，基于事件驱动。主要包含两部分Observable和Observaber。而Rxjava最大的特色在于其灵活强大的操作符(Operators)和调度器(Scheduler)
OperatorsCreating Observablescreate(OnSubscribe)
示例

123456789101112131415Observable.create(subscrib">
<meta property="og:image" content="http://xu6148152.github.io/./Observable.png">
<meta property="og:image" content="http://xu6148152.github.io/./Operator.png">
<meta property="og:updated_time" content="2017-01-01T15:27:27.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="深入理解RxJava">
<meta name="twitter:description" content="RxJava使用观察者模式，基于事件驱动。主要包含两部分Observable和Observaber。而Rxjava最大的特色在于其灵活强大的操作符(Operators)和调度器(Scheduler)
OperatorsCreating Observablescreate(OnSubscribe)
示例

123456789101112131415Observable.create(subscrib">
<meta name="twitter:image" content="http://xu6148152.github.io/./Observable.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: 'Author'
    }
  };
</script>




  <link rel="canonical" href="http://xu6148152.github.io/2017/01/01/深入理解RxJava/"/>


  <title> 深入理解RxJava | Blog </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle"></p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
            Startseite
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
            Archiv
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
            Tags
          </a>
        </li>
      
        
        <li class="menu-item menu-item-schedule">
          <a href="/schedule" rel="section">
            
            Schedule
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                深入理解RxJava
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">Veröffentlicht am</span>
            <time itemprop="dateCreated" datetime="2017-01-01T23:27:27+08:00" content="2017-01-01">
              2017-01-01
            </time>
          </span>

          

          
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p><code>RxJava</code>使用观察者模式，基于事件驱动。主要包含两部分<code>Observable</code>和<code>Observaber</code>。而<code>Rxjava</code>最大的特色在于其灵活强大的操作符(<code>Operators</code>)和调度器(<code>Scheduler</code>)</p>
<h3 id="Operators"><a href="#Operators" class="headerlink" title="Operators"></a>Operators</h3><h4 id="Creating-Observables"><a href="#Creating-Observables" class="headerlink" title="Creating Observables"></a>Creating Observables</h4><h5 id="create-OnSubscribe"><a href="#create-OnSubscribe" class="headerlink" title="create(OnSubscribe)"></a>create(OnSubscribe)</h5><blockquote>
<p>示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Observable.create(subscriber -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"subscriber"</span>);</span><br><span class="line">        &#125;).subscribe(<span class="keyword">new</span> Subscriber&lt;Object&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"onCompleted"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"onError"</span>);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"onNext"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>这种情况下会打印<code>subscriber</code>。</li>
<li>这个时候加上</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (!subscriber.isUnsubscribed()) &#123;</span><br><span class="line">                subscriber.onNext(subscriber);</span><br><span class="line">                subscriber.onCompleted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>那么会打印</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">onNext</span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析: </li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">create</span><span class="params">(OnSubscribe&lt;T&gt; f)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> Observable&lt;T&gt;(RxJavaHooks.onCreate(f));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>通过<code>RxJavaHooks</code>创建<code>OnSubscribe</code></li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; Observable.<span class="function">OnSubscribe&lt;T&gt; <span class="title">onCreate</span><span class="params">(Observable.OnSubscribe&lt;T&gt; onSubscribe)</span> </span>&#123;</span><br><span class="line">        Func1&lt;Observable.OnSubscribe, Observable.OnSubscribe&gt; f = onObservableCreate;</span><br><span class="line">        <span class="keyword">if</span> (f != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> f.call(onSubscribe);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> onSubscribe;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li><code>RxJavaHooks</code>会在首次使用的时候初始化。</li>
</ul>
<p>之后还需要订阅</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">Observable.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> &lt;T&gt; <span class="function">Subscription <span class="title">subscribe</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; subscriber, Observable&lt;T&gt; observable)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//省略若干代码</span></span><br><span class="line">	RxJavaHooks.onObservableStart(observable, observable.onSubscribe).call(subscriber);     </span><br><span class="line">	<span class="comment">//省略异常处理代码</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">RxJavaHooks.java</span><br><span class="line"></span><br><span class="line">onObservableStart = <span class="keyword">new</span> Func2&lt;Observable, Observable.OnSubscribe, Observable.OnSubscribe&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> Observable.<span class="function">OnSubscribe <span class="title">call</span><span class="params">(Observable t1, Observable.OnSubscribe t2)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> RxJavaPlugins.getInstance().getObservableExecutionHook().onSubscribeStart(t1, t2);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">RxJavaPlugins.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">OnSubscribe&lt;T&gt; <span class="title">onSubscribeStart</span><span class="params">(Observable&lt;? extends T&gt; observableInstance, <span class="keyword">final</span> OnSubscribe&lt;T&gt; onSubscribe)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// pass through by default</span></span><br><span class="line">        <span class="keyword">return</span> onSubscribe;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li><p>判断订阅者是否为空,之后直接交给<code>RxJavaHooks</code>执行<code>onObservableStart</code>，这里的参数<code>observable.onSubscribe</code>正是<code>Create</code>传入的，而在<code>RxJavaHooks</code>中<code>onObservableStart</code>调用了<code>RxJavaPlugin</code>中的<code>onSubscribeStart</code>。这个方法直接返回原来的<code>OnSubscribe</code>也就是<code>Create</code>传入的。这个时候会回调<code>call</code>。</p>
</li>
<li><p><code>create()</code>有另外两种参数专门用于处理<code>backPressure(反向压力，生产者生产速度远大于消费者消费速度)</code>。</p>
</li>
</ul>
<p><code>SyncOnSubscribe</code>里面需要关注的是<code>SubscriptionProducer</code>，而<code>AsyncOnSubscribe</code>需要关注<code>AsyncOuterManager</code>。这两个东西之后再讨论(TODO)</p>
<h5 id="defer"><a href="#defer" class="headerlink" title="defer"></a>defer</h5><blockquote>
<p>直到观察者订阅之后才创建可观察对象，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Observable.defer(Observable::empty).subscribe(<span class="keyword">new</span> Subscriber&lt;Object&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"onCompleted"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"onError"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        </span><br><span class="line">            <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Object o)</span> </span>&#123;</span><br><span class="line">                System.out.println(<span class="string">"onNext"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Observable.java</span><br><span class="line"></span><br><span class="line"><span class="number">2.0</span>.3</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">defer</span><span class="params">(Callable&lt;? extends ObservableSource&lt;? extends T&gt;&gt; supplier)</span> </span>&#123;</span><br><span class="line">        ObjectHelper.requireNonNull(supplier, <span class="string">"supplier is null"</span>);</span><br><span class="line">        <span class="keyword">return</span> RxJavaPlugins.onAssembly(<span class="keyword">new</span> ObservableDefer&lt;T&gt;(supplier));</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line"><span class="number">1.2</span>.4</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">defer</span><span class="params">(Func0&lt;Observable&lt;T&gt;&gt; observableFactory)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> create(<span class="keyword">new</span> OnSubscribeDefer&lt;T&gt;(observableFactory));</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>1.2.4采用<code>OnSubscribeDefer</code>,2.0.3采用<code>ObservableDefer</code>。</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">OnSubscribeDefer.java</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> T&gt; s)</span> </span>&#123;</span><br><span class="line">        Observable&lt;? extends T&gt; o;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            o = observableFactory.call();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            Exceptions.throwOrReport(t, s);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        o.unsafeSubscribe(Subscribers.wrap(s));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ObservableDefer.java</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribeActual</span><span class="params">(Observer&lt;? <span class="keyword">super</span> T&gt; s)</span> </span>&#123;</span><br><span class="line">        ObservableSource&lt;? extends T&gt; pub;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            pub = ObjectHelper.requireNonNull(supplier.call(), <span class="string">"null publisher supplied"</span>);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            Exceptions.throwIfFatal(t);</span><br><span class="line">            EmptyDisposable.error(t, s);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        pub.subscribe(s);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<h5 id="Empty-Never-Throw"><a href="#Empty-Never-Throw" class="headerlink" title="Empty Never Throw"></a>Empty Never Throw</h5><blockquote>
<p>Empty</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">EmptyObservableHolder.java</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Object&gt; child)</span> </span>&#123;</span><br><span class="line">        child.onCompleted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>直接调用<code>onCompleted</code>，这是一个枚举单例</li>
</ul>
<blockquote>
<p>Never</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">NeverObservableHolder.java</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> Object&gt; child)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// deliberately no op</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>什么都不做，主要用于做测试,这是一个枚举单例</li>
</ul>
<blockquote>
<p>Throw</p>
</blockquote>
<ul>
<li>源码分析:</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span> </span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; observer)</span> </span>&#123;</span><br><span class="line">        observer.onError(exception);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<h5 id="From"><a href="#From" class="headerlink" title="From"></a>From</h5><blockquote>
<p>将<code>Future</code>转化成<code>Observable</code>，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(Executors.newSingleThreadExecutor().submit(() -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"before sleep"</span>);</span><br><span class="line">            Thread.sleep(<span class="number">5000</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;)).subscribe(mSubscriber);</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>打印结果</li>
</ul>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">before sleep</span><br><span class="line">onNext</span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">from</span><span class="params">(Future&lt;? extends T&gt; future)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> (Observable&lt;T&gt;)create(OnSubscribeToObservableFuture.toObservableFuture(future));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">OnSubscribeToObservableFuture.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">OnSubscribe&lt;T&gt; <span class="title">toObservableFuture</span><span class="params">(<span class="keyword">final</span> Future&lt;? extends T&gt; that)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ToObservableFuture&lt;T&gt;(that);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; subscriber)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//核心代码</span></span><br><span class="line">        <span class="keyword">if</span> (subscriber.isUnsubscribed()) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                T value = (unit == <span class="keyword">null</span>) ? (T) that.get() : (T) that.get(time, unit);</span><br><span class="line">                subscriber.setProducer(<span class="keyword">new</span> SingleProducer&lt;T&gt;(subscriber, value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>等待<code>future</code>结果。将结果作为生产者发出消息.<code>push data</code></li>
</ul>
<blockquote>
<p>将数组转换成Observable</p>
</blockquote>
<ul>
<li>源码</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">OnSubscribeFromArray.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; child)</span> </span>&#123;</span><br><span class="line">        child.setProducer(<span class="keyword">new</span> FromArrayProducer&lt;T&gt;(child, array));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>这里面依然涉及到反向压力的处理，当请求id等于阈值时采用<code>fastPath</code>处理。反之采用<code>slowPath</code>。正常情况下请求id都是<code>Long.MaxValue</code>，当<code>producer</code>为空时，id会发生改变</li>
</ul>
<h5 id="Interval"><a href="#Interval" class="headerlink" title="Interval"></a>Interval</h5><blockquote>
<p>定时发出事件,示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">5</span>);</span><br><span class="line">        <span class="keyword">long</span> startTime = System.currentTimeMillis();</span><br><span class="line">        Observable.interval(<span class="number">1</span>, TimeUnit.SECONDS).subscribe(counter -&gt; &#123;</span><br><span class="line">            latch.countDown();</span><br><span class="line">            System.out.println(<span class="string">"Got: "</span> + counter + <span class="string">" time: "</span> + (System.currentTimeMillis() - startTime));</span><br><span class="line">        &#125;);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            latch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">结果</span><br><span class="line">Got: <span class="number">0</span> time: <span class="number">1252</span></span><br><span class="line">Got: <span class="number">1</span> time: <span class="number">2245</span></span><br><span class="line">Got: <span class="number">2</span> time: <span class="number">3249</span></span><br><span class="line">Got: <span class="number">3</span> time: <span class="number">4247</span></span><br><span class="line">Got: <span class="number">4</span> time: <span class="number">5244</span></span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">OnSubscribeTimerPeriodically.java</span><br><span class="line"></span><br><span class="line">默认使用computation调度器</span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> Long&gt; child)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Worker worker = scheduler.createWorker();</span><br><span class="line">        child.add(worker);</span><br><span class="line">        worker.schedulePeriodically(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line">            <span class="keyword">long</span> counter;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    child.onNext(counter++);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        worker.unsubscribe();</span><br><span class="line">                    &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                        Exceptions.throwOrReport(e, child);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;, initialDelay, period, unit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>创建工作器。工作器串行执行。</li>
</ul>
<h5 id="Just"><a href="#Just" class="headerlink" title="Just"></a>Just</h5><blockquote>
<p>发送特定的消息，有多个重载方法，区分在于单个参数和多个参数，单个参数使用ScalarSynchronousObservable,而多个参数使用from</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">ScalarSynchronousObservable.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="title">ScalarSynchronousObservable</span><span class="params">(<span class="keyword">final</span> T t)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(RxJavaHooks.onCreate(<span class="keyword">new</span> JustOnSubscribe&lt;T&gt;(t)));</span><br><span class="line">        <span class="keyword">this</span>.t = t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(Subscriber&lt;? <span class="keyword">super</span> T&gt; s)</span> </span>&#123;</span><br><span class="line">            s.setProducer(createProducer(s, value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li><ul>
<li>创建生产者时区分单生产者和弱单生产者</li>
</ul>
</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">WeakSingleProducer.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (once) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (n &lt; <span class="number">0L</span>) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"n &gt;= required but it was "</span> + n);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (n == <span class="number">0L</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            once = <span class="keyword">true</span>;</span><br><span class="line">            Subscriber&lt;? <span class="keyword">super</span> T&gt; a = actual;</span><br><span class="line">            <span class="keyword">if</span> (a.isUnsubscribed()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            T v = value;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                a.onNext(v);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                Exceptions.throwOrReport(e, a, v);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (a.isUnsubscribed()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            a.onCompleted();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>弱单生产者不考虑并发问题，仅仅只使用<code>once</code>来记录此次请求已经发出</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">        <span class="comment">// negative requests are bugs</span></span><br><span class="line">        <span class="keyword">if</span> (n &lt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"n &gt;= 0 required"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// we ignore zero requests</span></span><br><span class="line">        <span class="keyword">if</span> (n == <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// atomically change the state into emitting mode</span></span><br><span class="line">        <span class="keyword">if</span> (compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>)) &#123;</span><br><span class="line">            <span class="comment">// avoid re-reading the instance fields</span></span><br><span class="line">            <span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> T&gt; c = child;</span><br><span class="line">            <span class="comment">// eagerly check for unsubscription</span></span><br><span class="line">            <span class="keyword">if</span> (c.isUnsubscribed()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            T v = value;</span><br><span class="line">            <span class="comment">// emit the value</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                c.onNext(v);</span><br><span class="line">            &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">                Exceptions.throwOrReport(e, c, v);</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// eagerly check for unsubscription</span></span><br><span class="line">            <span class="keyword">if</span> (c.isUnsubscribed()) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// complete the child</span></span><br><span class="line">            c.onCompleted();</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>单生产者考虑并发问题，继承<code>AtomicBoolean</code>，通过<code>compareAndSet</code>来确保线程安全</li>
</ul>
<h5 id="Range"><a href="#Range" class="headerlink" title="Range"></a>Range</h5><blockquote>
<p>串行发出某一范围的消息</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">long</span> requestedAmount)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (get() == Long.MAX_VALUE) &#123;</span><br><span class="line">                <span class="comment">// already started with fast-path</span></span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (requestedAmount == Long.MAX_VALUE &amp;&amp; compareAndSet(<span class="number">0L</span>, Long.MAX_VALUE)) &#123;</span><br><span class="line">                <span class="comment">// fast-path without backpressure</span></span><br><span class="line">                fastPath();</span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (requestedAmount &gt; <span class="number">0L</span>) &#123;</span><br><span class="line">                <span class="keyword">long</span> c = BackpressureUtils.getAndAddRequest(<span class="keyword">this</span>, requestedAmount);</span><br><span class="line">                <span class="keyword">if</span> (c == <span class="number">0L</span>) &#123;</span><br><span class="line">                    <span class="comment">// backpressure is requested</span></span><br><span class="line">                    slowPath(requestedAmount);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>策略依然跟大部分<code>producer</code>一样,正常情况下使用<code>fastPath</code>，<code>slowPath</code>则会考虑线程安全</li>
</ul>
<h5 id="Repeat"><a href="#Repeat" class="headerlink" title="Repeat"></a>Repeat</h5><blockquote>
<p>重复发出消息，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Observable.range(<span class="number">0</span>, <span class="number">3</span>).repeat(<span class="number">3</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">打印结果:</span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onCompleted</span><br><span class="line"></span><br><span class="line">打印三组range</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br></pre></td><td class="code"><pre><span class="line">repeat默认使用trampoline作为线程调度器，在当前线程串行执行</span><br><span class="line"></span><br><span class="line">OnSubscribeRedo.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> T&gt; child)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//订阅源消息</span></span><br><span class="line">	<span class="keyword">final</span> Action0 subscribeToSource = <span class="keyword">new</span> Action0() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">if</span> (child.isUnsubscribed()) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                Subscriber&lt;T&gt; terminalDelegatingSubscriber = <span class="keyword">new</span> Subscriber&lt;T&gt;() &#123;</span><br><span class="line">                    <span class="keyword">boolean</span> done;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (!done) &#123;</span><br><span class="line">                            done = <span class="keyword">true</span>;</span><br><span class="line">                            unsubscribe();</span><br><span class="line">                            terminals.onNext(Notification.createOnCompleted());</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (!done) &#123;</span><br><span class="line">                            done = <span class="keyword">true</span>;</span><br><span class="line">                            unsubscribe();</span><br><span class="line">                            terminals.onNext(Notification.createOnError(e));</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T v)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (!done) &#123;</span><br><span class="line">                            child.onNext(v);</span><br><span class="line">                            decrementConsumerCapacity();</span><br><span class="line">                            arbiter.produced(<span class="number">1</span>);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">decrementConsumerCapacity</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="comment">// use a CAS loop because we don't want to decrement the</span></span><br><span class="line">                        <span class="comment">// value if it is Long.MAX_VALUE</span></span><br><span class="line">                        <span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">                            <span class="keyword">long</span> cc = consumerCapacity.get();</span><br><span class="line">                            <span class="keyword">if</span> (cc != Long.MAX_VALUE) &#123;</span><br><span class="line">                                <span class="keyword">if</span> (consumerCapacity.compareAndSet(cc, cc - <span class="number">1</span>)) &#123;</span><br><span class="line">                                    <span class="keyword">break</span>;</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="keyword">break</span>;</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProducer</span><span class="params">(Producer producer)</span> </span>&#123;</span><br><span class="line">                        arbiter.setProducer(producer);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;;</span><br><span class="line">                <span class="comment">// new subscription each time so if it unsubscribes itself it does not prevent retries</span></span><br><span class="line">                <span class="comment">// by unsubscribing the child subscription</span></span><br><span class="line">                sourceSubscriptions.set(terminalDelegatingSubscriber);</span><br><span class="line">                source.unsafeSubscribe(terminalDelegatingSubscriber);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        </span><br><span class="line">        <span class="comment">//重复发送源消息</span></span><br><span class="line">        <span class="keyword">final</span> Observable&lt;?&gt; restarts = controlHandlerFunction.call(</span><br><span class="line">                terminals.lift(<span class="keyword">new</span> Operator&lt;Notification&lt;?&gt;, Notification&lt;?&gt;&gt;() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="keyword">public</span> Subscriber&lt;? <span class="keyword">super</span> Notification&lt;?&gt;&gt; call(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> Notification&lt;?&gt;&gt; filteredTerminals) &#123;</span><br><span class="line">                        <span class="keyword">return</span> <span class="keyword">new</span> Subscriber&lt;Notification&lt;?&gt;&gt;(filteredTerminals) &#123;</span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                filteredTerminals.onCompleted();</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                                filteredTerminals.onError(e);</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Notification&lt;?&gt; t)</span> </span>&#123;</span><br><span class="line">                                <span class="keyword">if</span> (t.isOnCompleted() &amp;&amp; stopOnComplete) &#123;</span><br><span class="line">                                    filteredTerminals.onCompleted();</span><br><span class="line">                                &#125; <span class="keyword">else</span> <span class="keyword">if</span> (t.isOnError() &amp;&amp; stopOnError) &#123;</span><br><span class="line">                                    filteredTerminals.onError(t.getThrowable());</span><br><span class="line">                                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                    filteredTerminals.onNext(t);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line"></span><br><span class="line">                            <span class="meta">@Override</span></span><br><span class="line">                            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProducer</span><span class="params">(Producer producer)</span> </span>&#123;</span><br><span class="line">                                producer.request(Long.MAX_VALUE);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;));</span><br><span class="line">     <span class="comment">//订阅重复发送的源消息           </span></span><br><span class="line">     worker.schedule(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                restarts.unsafeSubscribe(<span class="keyword">new</span> Subscriber&lt;Object&gt;(child) &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        child.onCompleted();</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                        child.onError(e);</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Object t)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (!child.isUnsubscribed()) &#123;</span><br><span class="line">                            <span class="comment">// perform a best endeavours check on consumerCapacity</span></span><br><span class="line">                            <span class="comment">// with the intent of only resubscribing immediately</span></span><br><span class="line">                            <span class="comment">// if there is outstanding capacity</span></span><br><span class="line">                            <span class="keyword">if</span> (consumerCapacity.get() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                worker.schedule(subscribeToSource);</span><br><span class="line">                            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                <span class="comment">// set this to true so that on next request</span></span><br><span class="line">                                <span class="comment">// subscribeToSource will be scheduled</span></span><br><span class="line">                                resumeBoundary.compareAndSet(<span class="keyword">false</span>, <span class="keyword">true</span>);</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line"></span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProducer</span><span class="params">(Producer producer)</span> </span>&#123;</span><br><span class="line">                        producer.request(Long.MAX_VALUE);</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);                </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>流程<ol>
<li>订阅源消息</li>
<li>重复发送源消息</li>
<li>订阅重复发送的源消息</li>
</ol>
</li>
</ul>
<h5 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h5><blockquote>
<p>延时特定时间后发出一个消息，默认使用computation作为线程调度器</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> Long&gt; child)</span> </span>&#123;</span><br><span class="line">        Worker worker = scheduler.createWorker();</span><br><span class="line">        child.add(worker);</span><br><span class="line">        worker.schedule(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    child.onNext(<span class="number">0L</span>);</span><br><span class="line">                &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">                    Exceptions.throwOrReport(t, child);</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                child.onCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, time, unit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<h4 id="Transforming-Observables"><a href="#Transforming-Observables" class="headerlink" title="Transforming Observables"></a>Transforming Observables</h4><h5 id="Buffer"><a href="#Buffer" class="headerlink" title="Buffer"></a>Buffer</h5><blockquote>
<p>缓存源数据发出的消息，再一起发出。示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Integer[] integers = <span class="keyword">new</span> Integer[<span class="number">9</span>];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; integers.length; i++) &#123;</span><br><span class="line">    integers[i] = i;</span><br><span class="line">&#125;</span><br><span class="line">Observable.from(integers).buffer(<span class="number">2</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:<span class="number">2</span>个值一组</span><br><span class="line"></span><br><span class="line">onNext value: [<span class="number">0</span>, <span class="number">1</span>]</span><br><span class="line">onNext value: [<span class="number">2</span>, <span class="number">3</span>]</span><br><span class="line">onNext value: [<span class="number">4</span>, <span class="number">5</span>]</span><br><span class="line">onNext value: [<span class="number">6</span>, <span class="number">7</span>]</span><br><span class="line">onNext value: [<span class="number">8</span>]</span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<h6 id="buffer-int-count-int-skip"><a href="#buffer-int-count-int-skip" class="headerlink" title="buffer(int count, int skip)"></a><code>buffer(int count, int skip)</code></h6><p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">OperatorBufferWithSize.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Subscriber&lt;? <span class="keyword">super</span> T&gt; call(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> List&lt;T&gt;&gt; child) &#123;</span><br><span class="line">        <span class="keyword">if</span> (skip == count) &#123;</span><br><span class="line">            BufferExact&lt;T&gt; parent = <span class="keyword">new</span> BufferExact&lt;T&gt;(child, count);</span><br><span class="line"></span><br><span class="line">            child.add(parent);</span><br><span class="line">            child.setProducer(parent.createProducer());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> parent;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (skip &gt; count) &#123;</span><br><span class="line">            BufferSkip&lt;T&gt; parent = <span class="keyword">new</span> BufferSkip&lt;T&gt;(child, count, skip);</span><br><span class="line"></span><br><span class="line">            child.add(parent);</span><br><span class="line">            child.setProducer(parent.createProducer());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> parent;</span><br><span class="line">        &#125;</span><br><span class="line">        BufferOverlap&lt;T&gt; parent = <span class="keyword">new</span> BufferOverlap&lt;T&gt;(child, count, skip);</span><br><span class="line"></span><br><span class="line">        child.add(parent);</span><br><span class="line">        child.setProducer(parent.createProducer());</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> parent;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>当<code>skip</code>等于<code>count</code>(默认情况)</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">BufferExact</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">            List&lt;T&gt; b = buffer;</span><br><span class="line">            <span class="keyword">if</span> (b == <span class="keyword">null</span>) &#123;</span><br><span class="line">                b = <span class="keyword">new</span> ArrayList&lt;T&gt;(count);</span><br><span class="line">                buffer = b;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            b.add(t);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (b.size() == count) &#123;</span><br><span class="line">                buffer = <span class="keyword">null</span>;</span><br><span class="line">                actual.onNext(b);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li><p>创建大小为<code>count</code>的数组，将接收到的数组添加到数组中，数组满，将数组作为数据发出</p>
</li>
<li><p><code>skip</code>大于<code>count</code></p>
</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">BufferSkip.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">long</span> i = index;</span><br><span class="line">            List&lt;T&gt; b = buffer;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                b = <span class="keyword">new</span> ArrayList&lt;T&gt;(count);</span><br><span class="line">                buffer = b;</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">if</span> (i == skip) &#123;</span><br><span class="line">                index = <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                index = i;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (b != <span class="keyword">null</span>) &#123;</span><br><span class="line">                b.add(t);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (b.size() == count) &#123;</span><br><span class="line">                    buffer = <span class="keyword">null</span>;</span><br><span class="line">                    actual.onNext(b);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li><p>每组<code>count</code>个，接收<code>skip</code>个数据，填满<code>count</code>个，剩余丢弃</p>
</li>
<li><p><code>count</code>大于<code>skip</code></p>
</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">BufferOverlap.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">long</span> i = index;</span><br><span class="line">            <span class="keyword">if</span> (i == <span class="number">0</span>) &#123;</span><br><span class="line">                List&lt;T&gt; b = <span class="keyword">new</span> ArrayList&lt;T&gt;(count);</span><br><span class="line">                queue.offer(b);</span><br><span class="line">            &#125;</span><br><span class="line">            i++;</span><br><span class="line">            <span class="keyword">if</span> (i == skip) &#123;</span><br><span class="line">                index = <span class="number">0</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                index = i;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (List&lt;T&gt; list : queue) &#123;</span><br><span class="line">                list.add(t);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            List&lt;T&gt; b = queue.peek();</span><br><span class="line">            <span class="keyword">if</span> (b != <span class="keyword">null</span> &amp;&amp; b.size() == count) &#123;</span><br><span class="line">                queue.poll();</span><br><span class="line">                produced++;</span><br><span class="line">                actual.onNext(b);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>使用<code>ArrayDeque</code>存储每组数据。<code>ArrayDeque</code>会储存之前的数据。</li>
</ul>
<h6 id="buffer-Func0"><a href="#buffer-Func0" class="headerlink" title="buffer(Func0)"></a>buffer(Func0)</h6><ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">OperatorBufferWithSingleObservable.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Subscriber&lt;? <span class="keyword">super</span> T&gt; call(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> List&lt;T&gt;&gt; child) &#123;</span><br><span class="line">        Observable&lt;? extends TClosing&gt; closing;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            closing = bufferClosingSelector.call();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span><br><span class="line">            Exceptions.throwOrReport(t, child);</span><br><span class="line">            <span class="keyword">return</span> Subscribers.empty();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">final</span> BufferingSubscriber s = <span class="keyword">new</span> BufferingSubscriber(<span class="keyword">new</span> SerializedSubscriber&lt;List&lt;T&gt;&gt;(child));</span><br><span class="line"></span><br><span class="line">        Subscriber&lt;TClosing&gt; closingSubscriber = <span class="keyword">new</span> Subscriber&lt;TClosing&gt;() &#123;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(TClosing t)</span> </span>&#123;</span><br><span class="line">                s.emit();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                s.onError(e);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                s.onCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        child.add(closingSubscriber);</span><br><span class="line">        child.add(s);</span><br><span class="line"></span><br><span class="line">        closing.unsafeSubscribe(closingSubscriber);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> s;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li><code>bufferClosingSelector</code>产生的<code>Observable</code>订阅<code>BufferingSubscriber</code>其内部使用<code>chunk</code>收集数据，当<code>closingSubscriber</code>被订阅，将<code>chunk</code>数据发出</li>
</ul>
<h6 id="buffer-long-timespan-long-timeshift-TimeUnit-unit"><a href="#buffer-long-timespan-long-timeshift-TimeUnit-unit" class="headerlink" title="buffer(long timespan, long timeshift, TimeUnit unit)"></a>buffer(long timespan, long timeshift, TimeUnit unit)</h6><ul>
<li>源码分析<blockquote>
<p>默认使用computation线程调度</p>
</blockquote>
</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">OperatorBufferWithTime.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="title">if</span> <span class="params">(timespan == timeshift)</span> </span>&#123;</span><br><span class="line">            ExactSubscriber parent = <span class="keyword">new</span> ExactSubscriber(serialized, inner);</span><br><span class="line">            parent.add(inner);</span><br><span class="line">            child.add(parent);</span><br><span class="line">            parent.scheduleExact();</span><br><span class="line">            <span class="keyword">return</span> parent;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        InexactSubscriber parent = <span class="keyword">new</span> InexactSubscriber(serialized, inner);</span><br><span class="line">        parent.add(inner);</span><br><span class="line">        child.add(parent);</span><br><span class="line">        parent.startNewChunk();</span><br><span class="line">        parent.scheduleChunk();</span><br><span class="line"><span class="keyword">return</span> parent;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>数据刷新时间和数据块创建时间一样时使用<code>ExactSubscriber</code></li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">            List&lt;T&gt; toEmit = <span class="keyword">null</span>;</span><br><span class="line">            <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</span><br><span class="line">                <span class="keyword">if</span> (done) &#123;</span><br><span class="line">                    <span class="keyword">return</span>;</span><br><span class="line">                &#125;</span><br><span class="line">                chunk.add(t);</span><br><span class="line">                <span class="keyword">if</span> (chunk.size() == count) &#123;</span><br><span class="line">                    toEmit = chunk;</span><br><span class="line">                    chunk = <span class="keyword">new</span> ArrayList&lt;T&gt;();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (toEmit != <span class="keyword">null</span>) &#123;</span><br><span class="line">                child.onNext(toEmit);</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>反之使用<code>InexactSubscriber</code>，其使用<code>LinkedList</code>作为<code>chunk</code>数据结构。用于存储多余的数据。数据生成的速度大于处理速度</li>
</ul>
<h5 id="FlatMap"><a href="#FlatMap" class="headerlink" title="FlatMap"></a>FlatMap</h5><blockquote>
<p>转换消息成被观察对象，对map(func)的结果做merge</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">Observable.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">Observable&lt;T&gt; <span class="title">merge</span><span class="params">(Observable&lt;? extends Observable&lt;? extends T&gt;&gt; source)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (source.getClass() == ScalarSynchronousObservable.class) &#123;</span><br><span class="line">            <span class="keyword">return</span> ((ScalarSynchronousObservable&lt;T&gt;)source).scalarFlatMap((Func1)UtilityFunctions.identity());</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> source.lift(OperatorMerge.&lt;T&gt;instance(<span class="keyword">false</span>));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">OperatorMerge.java，合并多个Observable成一个</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Subscriber&lt;Observable&lt;? extends T&gt;&gt; call(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> T&gt; child) &#123;</span><br><span class="line">        MergeSubscriber&lt;T&gt; subscriber = <span class="keyword">new</span> MergeSubscriber&lt;T&gt;(child, delayErrors, maxConcurrent);</span><br><span class="line">        MergeProducer&lt;T&gt; producer = <span class="keyword">new</span> MergeProducer&lt;T&gt;(subscriber);</span><br><span class="line">        subscriber.producer = producer;</span><br><span class="line"></span><br><span class="line">        child.add(subscriber);</span><br><span class="line">        child.setProducer(producer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> subscriber;</span><br><span class="line"> &#125;</span><br><span class="line"> </span><br><span class="line"> MergeSubscriber.<span class="function">java</span><br><span class="line"> </span><br><span class="line"> <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(Observable&lt;? extends T&gt; t)</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (t == <span class="keyword">null</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (t == Observable.empty()) &#123;</span><br><span class="line">                emitEmpty();</span><br><span class="line">            &#125; <span class="keyword">else</span></span><br><span class="line">            <span class="keyword">if</span> (t <span class="keyword">instanceof</span> ScalarSynchronousObservable) &#123;</span><br><span class="line">                tryEmit(((ScalarSynchronousObservable&lt;? extends T&gt;)t).get());</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                InnerSubscriber&lt;T&gt; inner = <span class="keyword">new</span> InnerSubscriber&lt;T&gt;(<span class="keyword">this</span>, uniqueId++);</span><br><span class="line">                addInner(inner);</span><br><span class="line">                t.unsafeSubscribe(inner);</span><br><span class="line">                emit();</span><br><span class="line">            &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>创建<code>InnerSubscriber</code>，其内部会调用<code>tryEmit</code>。之后调用<code>emitLoop</code>，循环从唤醒队列中取出消息发出</li>
</ul>
<h5 id="GroupBy"><a href="#GroupBy" class="headerlink" title="GroupBy"></a>GroupBy</h5><blockquote>
<p>将源数据按特征分组，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>)</span><br><span class="line">                  .groupBy(integer -&gt; integer % <span class="number">2</span> == <span class="number">0</span>)</span><br><span class="line">                  .subscribe(grouped -&gt; grouped.toList().subscribe(integers -&gt; System.out.println(integers + <span class="string">" (Even: "</span> + grouped.getKey() + <span class="string">")"</span>)));</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br></pre></td><td class="code"><pre><span class="line">OperatorGroupBy.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Subscriber&lt;? <span class="keyword">super</span> T&gt; call(Subscriber&lt;? <span class="keyword">super</span> GroupedObservable&lt;K, V&gt;&gt; child) &#123;</span><br><span class="line">        <span class="keyword">final</span> GroupBySubscriber&lt;T, K, V&gt; parent; <span class="comment">// NOPMD</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            parent = <span class="keyword">new</span> GroupBySubscriber&lt;T, K, V&gt;(child, keySelector, valueSelector, bufferSize, delayError, mapFactory);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">            <span class="comment">//Can reach here because mapFactory.call() may throw in constructor of GroupBySubscriber</span></span><br><span class="line">            Exceptions.throwOrReport(ex, child);</span><br><span class="line">            Subscriber&lt;? <span class="keyword">super</span> T&gt; parent2 = Subscribers.empty();</span><br><span class="line">            parent2.unsubscribe();</span><br><span class="line">            <span class="keyword">return</span> parent2;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        child.add(Subscriptions.create(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                parent.cancel();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;));</span><br><span class="line"></span><br><span class="line">        child.setProducer(parent.producer);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> parent;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">GroupBySubscriber.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">	K key;</span><br><span class="line">	<span class="keyword">try</span> &#123;</span><br><span class="line">	    key = keySelector.call(t);</span><br><span class="line">	&#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">	    unsubscribe();</span><br><span class="line">	    errorAll(a, q, ex);</span><br><span class="line">	    <span class="keyword">return</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	...</span><br><span class="line">	</span><br><span class="line">	<span class="keyword">if</span> (group == <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="comment">// if the main has been cancelled, stop creating groups</span></span><br><span class="line">        <span class="comment">// and skip this value</span></span><br><span class="line">        <span class="keyword">if</span> (!cancelled.get()) &#123;</span><br><span class="line">            group = GroupedUnicast.createWith(key, bufferSize, <span class="keyword">this</span>, delayError);</span><br><span class="line">            groups.put(mapKey, group);</span><br><span class="line"></span><br><span class="line">            groupCount.getAndIncrement();</span><br><span class="line"></span><br><span class="line">            notNew = <span class="keyword">false</span>;</span><br><span class="line">            q.offer(group);</span><br><span class="line">            drain();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    ...</span><br><span class="line">    </span><br><span class="line">    V v;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        v = valueSelector.call(t);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        unsubscribe();</span><br><span class="line">        errorAll(a, q, ex);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    group.onNext(v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>使用键选择器生成<code>key</code>，使用<code>key</code>创建<code>GroupedUnicast</code>存储起来。通过值选择器生成值并发出。</li>
</ul>
<h5 id="Map"><a href="#Map" class="headerlink" title="Map"></a>Map</h5><blockquote>
<p>与flatmap类似，flatmap多了merge步骤</p>
</blockquote>
<h5 id="Scan"><a href="#Scan" class="headerlink" title="Scan"></a>Scan</h5><blockquote>
<p>对新发出的信息与之前发出的消息一起做某种处理。示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">5</span>).scan((sum, value) -&gt; sum + value).subscribe(integer -&gt; System.out.println(<span class="string">"Sum: "</span> + integer));</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">Sum: <span class="number">1</span></span><br><span class="line">Sum: <span class="number">3</span></span><br><span class="line">Sum: <span class="number">6</span></span><br><span class="line">Sum: <span class="number">10</span></span><br><span class="line">Sum: <span class="number">15</span></span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">OperatorScan.java</span><br><span class="line"></span><br><span class="line"><span class="comment">//没有初始值</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">    R v;</span><br><span class="line">    <span class="keyword">if</span> (!once) &#123;</span><br><span class="line">        once = <span class="keyword">true</span>;</span><br><span class="line">        v = (R)t;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        v = value;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">        		<span class="comment">//使用之前的结果</span></span><br><span class="line">            v = accumulator.call(v, t);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            Exceptions.throwOrReport(e, child, t);</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    value = v;</span><br><span class="line">    child.onNext(v);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//有初始值</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T currentValue)</span> </span>&#123;</span><br><span class="line">    R v = value;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        v = accumulator.call(v, currentValue);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">        Exceptions.throwOrReport(e, <span class="keyword">this</span>, currentValue);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    value = v;</span><br><span class="line">    ip.onNext(v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>接收到消息，使用之前计算的结果和当前值做计算并存储</li>
</ul>
<h5 id="Window"><a href="#Window" class="headerlink" title="Window"></a>Window</h5><blockquote>
<p>与buffer类似，但其缓存后是以新的对象作为消息发出(Subject)</p>
</blockquote>
<h4 id="Filtering-Observables"><a href="#Filtering-Observables" class="headerlink" title="Filtering Observables"></a>Filtering Observables</h4><h5 id="Debounce"><a href="#Debounce" class="headerlink" title="Debounce"></a>Debounce</h5><blockquote>
<p>只发出经过特定时间从源消息接收到的消息，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).debounce(Observable::just).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">3</span></span><br><span class="line">onNext value: <span class="number">4</span></span><br><span class="line">onNext value: <span class="number">5</span></span><br><span class="line">onNext value: <span class="number">6</span></span><br><span class="line">onNext value: <span class="number">7</span></span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onCompleted</span><br><span class="line"></span><br><span class="line">Observable.from(integers).debounce(<span class="number">1</span>, TimeUnit.SECONDS).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">OperatorDebounceWithTime.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(<span class="keyword">final</span> T t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> index = state.next(t);</span><br><span class="line">    serial.set(worker.schedule(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            state.emit(index, s, self);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, timeout, unit));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>接收源消息自增。定时调用<code>emit</code>发送消息，如果源消息的发送速度快于当前调度时间，则这些事件会丢弃。事件发送结束时会发送最后一个消息</li>
</ul>
<h5 id="Distinct"><a href="#Distinct" class="headerlink" title="Distinct"></a>Distinct</h5><blockquote>
<p>过滤重复的消息，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>, <span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>).distinct().subscribe(integer -&gt; System.out.println(<span class="string">"integer: "</span> + integer));</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">integer: <span class="number">1</span></span><br><span class="line">integer: <span class="number">2</span></span><br><span class="line">integer: <span class="number">3</span></span><br><span class="line">integer: <span class="number">4</span></span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">OperatorDistinct.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">    U key = keySelector.call(t);</span><br><span class="line">    <span class="keyword">if</span> (keyMemory.add(key)) &#123;</span><br><span class="line">        child.onNext(t);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>使用一个<code>Set</code>来存储消息</li>
</ul>
<h5 id="ElementAt"><a href="#ElementAt" class="headerlink" title="ElementAt"></a>ElementAt</h5><blockquote>
<p>只发送第n个消息，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).elementAt(<span class="number">5</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">5</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OperatorElementAt.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (currentIndex++ == index) &#123;</span><br><span class="line">        child.onNext(value);</span><br><span class="line">        child.onCompleted();</span><br><span class="line">        unsubscribe();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>只有当第n个消息才发送</li>
</ul>
<h5 id="Filter"><a href="#Filter" class="headerlink" title="Filter"></a>Filter</h5><blockquote>
<p>按特定条件过滤消息，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.just(<span class="number">1</span>, <span class="number">2</span>, <span class="number">3</span>, <span class="number">4</span>).filter(integer -&gt; integer &gt; <span class="number">2</span>).subscribe(integer -&gt; System.out.println(<span class="string">"integer: "</span> + integer));</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">integer: <span class="number">3</span></span><br><span class="line">integer: <span class="number">4</span></span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">OnSubscribeFilter.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">boolean</span> result;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        result = predicate.call(t);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        Exceptions.throwIfFatal(ex);</span><br><span class="line">        unsubscribe();</span><br><span class="line">        onError(OnErrorThrowable.addValueAsLastCause(ex, t));</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (result) &#123;</span><br><span class="line">        actual.onNext(t);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>使用选择器过滤消息</li>
</ul>
<h5 id="first"><a href="#first" class="headerlink" title="first"></a>first</h5><blockquote>
<p>发出第一个消息，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).first(integer -&gt; <span class="keyword">false</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">可以决定第一个消息是否发出</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onError</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">OperatorTake.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T i)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!isUnsubscribed() &amp;&amp; count++ &lt; limit) &#123;</span><br><span class="line">        <span class="keyword">boolean</span> stop = count == limit;</span><br><span class="line">        child.onNext(i);</span><br><span class="line">        <span class="keyword">if</span> (stop &amp;&amp; !completed) &#123;</span><br><span class="line">            completed = <span class="keyword">true</span>;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                child.onCompleted();</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                unsubscribe();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>只发出指定数量的消息</li>
</ul>
<h5 id="IgnoreElements"><a href="#IgnoreElements" class="headerlink" title="IgnoreElements"></a>IgnoreElements</h5><blockquote>
<p>不发出任何消息，但发出结束的通知，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).ignoreElements().subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<h5 id="last"><a href="#last" class="headerlink" title="last"></a>last</h5><blockquote>
<p>只发出最后一个消息，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).last().subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">	<span class="comment">//存储最新的值</span></span><br><span class="line">    value = t;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object o = value;</span><br><span class="line">    <span class="keyword">if</span> (o == EMPTY) &#123;</span><br><span class="line">        complete();</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    	<span class="comment">//结束时，发出最后一个消息</span></span><br><span class="line">        complete((T)o);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>结束时，发出最后的消息</li>
</ul>
<h5 id="Sample"><a href="#Sample" class="headerlink" title="Sample"></a>Sample</h5><blockquote>
<p>发出一段时间内最近的消息</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">OperatorSampleWithTime.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">    value.set(t);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    emitIfNonEmpty();</span><br><span class="line">    subscriber.onCompleted();</span><br><span class="line">    unsubscribe();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">emitIfNonEmpty</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    Object localValue = value.getAndSet(EMPTY_TOKEN);</span><br><span class="line">    <span class="keyword">if</span> (localValue != EMPTY_TOKEN) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span><br><span class="line">            T v = (T)localValue;</span><br><span class="line">            subscriber.onNext(v);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span><br><span class="line">            Exceptions.throwOrReport(e, <span class="keyword">this</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>存储最新的值，结束时发出最新的值</li>
</ul>
<h5 id="skip"><a href="#skip" class="headerlink" title="skip"></a>skip</h5><blockquote>
<p>跳过n个消息不发送，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).skip(<span class="number">5</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">5</span></span><br><span class="line">onNext value: <span class="number">6</span></span><br><span class="line">onNext value: <span class="number">7</span></span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">OperatorSkip.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (skipped &gt;= toSkip) &#123;</span><br><span class="line">        child.onNext(t);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        skipped += <span class="number">1</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>跳过n个消息</li>
</ul>
<h5 id="skipLast"><a href="#skipLast" class="headerlink" title="skipLast"></a>skipLast</h5><blockquote>
<p>跳过后n个消息不发送，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).skipLast(<span class="number">5</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">3</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">OperatorSkipLast.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T value)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (count == <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="comment">// If count == 0, we do not need to put value into deque</span></span><br><span class="line">        <span class="comment">// and remove it at once. We can emit the value</span></span><br><span class="line">        <span class="comment">// directly.</span></span><br><span class="line">        subscriber.onNext(value);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> (deque.size() == count) &#123;</span><br><span class="line">        subscriber.onNext(NotificationLite.&lt;T&gt;getValue(deque.removeFirst()));</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        request(<span class="number">1</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    deque.offerLast(NotificationLite.next(value));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>使用双端队列存储消息，将前面的消息存入，当数量达到要求，从双端队列中取数据发送</li>
</ul>
<h5 id="Take-TakeLast"><a href="#Take-TakeLast" class="headerlink" title="Take, TakeLast"></a>Take, TakeLast</h5><blockquote>
<p>发送前n个消息</p>
</blockquote>
<ul>
<li>源码分析，前面已有</li>
</ul>
<h4 id="Combining-Observable"><a href="#Combining-Observable" class="headerlink" title="Combining Observable"></a>Combining Observable</h4><h5 id="And-Then-When"><a href="#And-Then-When" class="headerlink" title="And/Then/When"></a>And/Then/When</h5><blockquote>
<p>通过patter和plan合并多个消息源发出的数据集,不是rxjava核心库的一部分</p>
</blockquote>
<h5 id="CombineLast"><a href="#CombineLast" class="headerlink" title="CombineLast"></a>CombineLast</h5><blockquote>
<p>使用特定方法合并两个消息源最近的数据，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">        MySubscriber subscriber = <span class="keyword">new</span> MySubscriber();</span><br><span class="line">        subscriber.setCountDownLatch(countDownLatch);</span><br><span class="line">        Observable.combineLatest(Observable.interval(<span class="number">1</span>, TimeUnit.SECONDS).take(<span class="number">5</span>), Observable.from(integers), (first, second) -&gt; first + second).subscribe(subscriber);</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            countDownLatch.await();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onNext value: <span class="number">9</span></span><br><span class="line">onNext value: <span class="number">10</span></span><br><span class="line">onNext value: <span class="number">11</span></span><br><span class="line">onNext value: <span class="number">12</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li><p>第一个消息源一秒钟发出一个消息，第二个消息源一次性发完，因此合并消息会合并最后一个消息</p>
</li>
<li><p>源码分析</p>
</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">LatestCoordinator.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">subscribe</span><span class="params">(Observable&lt;? extends T&gt;[] sources)</span> </span>&#123;</span><br><span class="line">    Subscriber&lt;T&gt;[] as = subscribers;</span><br><span class="line">    <span class="keyword">int</span> len = as.length;</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        as[i] = <span class="keyword">new</span> CombinerSubscriber&lt;T, R&gt;(<span class="keyword">this</span>, i);</span><br><span class="line">    &#125;</span><br><span class="line">    lazySet(<span class="number">0</span>); <span class="comment">// release array contents</span></span><br><span class="line">    actual.add(<span class="keyword">this</span>);</span><br><span class="line">    actual.setProducer(<span class="keyword">this</span>);</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; len; i++) &#123;</span><br><span class="line">        <span class="keyword">if</span> (cancelled) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        ((Observable&lt;T&gt;)sources[i]).subscribe(as[i]);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>创建多个<code>CombinerSubscriber</code>对应多个消息源。</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">CombinerSubscriber.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> <span class="title">combine</span><span class="params">(Object value, <span class="keyword">int</span> index)</span> </span>&#123;</span><br><span class="line">	<span class="keyword">if</span> (!empty) &#123;</span><br><span class="line">        <span class="keyword">if</span> (value != <span class="keyword">null</span> &amp;&amp; allSourcesFinished) &#123;</span><br><span class="line">        <span class="comment">//插入最新的数据</span></span><br><span class="line">            queue.offer(combinerSubscriber, latest.clone());</span><br><span class="line">        &#125; <span class="keyword">else</span></span><br><span class="line">        <span class="keyword">if</span> (value == <span class="keyword">null</span> &amp;&amp; error.get() != <span class="keyword">null</span> &amp;&amp; (o == MISSING || !delayError)) &#123;</span><br><span class="line">            done = <span class="keyword">true</span>; <span class="comment">// if this source completed without a value</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        done = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">	 drain()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">drain() &#123;</span><br><span class="line">	R v;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        v = combiner.call(array);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable ex) &#123;</span><br><span class="line">        cancelled = <span class="keyword">true</span>;</span><br><span class="line">        cancel(q);</span><br><span class="line">        a.onError(ex);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    a.onNext(v);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>收集最近的数据到<code>SpscLinkedArrayQueue</code>中</li>
</ul>
<h5 id="Join"><a href="#Join" class="headerlink" title="Join"></a>Join</h5><blockquote>
<p>只要一个数据在另一个数据定义的时间窗口内发出，合并两个数据源发出的数据</p>
</blockquote>
<h5 id="Merge"><a href="#Merge" class="headerlink" title="Merge"></a>Merge</h5><blockquote>
<p>根据时间轴合并多个数据源成一个，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">1</span>);</span><br><span class="line">    MySubscriber subscriber = <span class="keyword">new</span> MySubscriber();</span><br><span class="line">    subscriber.setCountDownLatch(countDownLatch);</span><br><span class="line">    Observable.merge(Observable.interval(<span class="number">1</span>, TimeUnit.SECONDS).take(<span class="number">5</span>), Observable.from(integers)).subscribe(subscriber);</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        countDownLatch.await();</span><br><span class="line">    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">3</span></span><br><span class="line">onNext value: <span class="number">4</span></span><br><span class="line">onNext value: <span class="number">5</span></span><br><span class="line">onNext value: <span class="number">6</span></span><br><span class="line">onNext value: <span class="number">7</span></span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">3</span></span><br><span class="line">onNext value: <span class="number">4</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<h5 id="StartWith"><a href="#StartWith" class="headerlink" title="StartWith"></a>StartWith</h5><blockquote>
<p>开始发送数据前发送一系列指定的数据，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).startWith(<span class="number">100</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">100</span></span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">3</span></span><br><span class="line">onNext value: <span class="number">4</span></span><br><span class="line">onNext value: <span class="number">5</span></span><br><span class="line">onNext value: <span class="number">6</span></span><br><span class="line">onNext value: <span class="number">7</span></span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析，其使用的是<code>concat</code></li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">OnSubscribeConcatMap.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (!queue.offer(NotificationLite.next(t))) &#123;</span><br><span class="line">        unsubscribe();</span><br><span class="line">        onError(<span class="keyword">new</span> MissingBackpressureException());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        drain();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>队列未满时，往队列里插入数据，之后调用<code>drain</code>消费数据</li>
</ul>
<h5 id="Switch"><a href="#Switch" class="headerlink" title="Switch"></a>Switch</h5><blockquote>
<p>转换多个数据源为单个数据源，使用最近数据转换，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers1).switchIfEmpty(Observable.from(integers)).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: <span class="number">1</span></span><br><span class="line">onNext value: <span class="number">2</span></span><br><span class="line">onNext value: <span class="number">3</span></span><br><span class="line">onNext value: <span class="number">4</span></span><br><span class="line">onNext value: <span class="number">5</span></span><br><span class="line">onNext value: <span class="number">6</span></span><br><span class="line">onNext value: <span class="number">7</span></span><br><span class="line">onNext value: <span class="number">8</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<h5 id="zip"><a href="#zip" class="headerlink" title="zip"></a>zip</h5><blockquote>
<p>按数据合并两个数据源，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Observable&lt;Integer&gt; evens = Observable.just(<span class="number">2</span>, <span class="number">4</span>, <span class="number">6</span>, <span class="number">8</span>, <span class="number">10</span>);</span><br><span class="line">        Observable&lt;Integer&gt; odds = Observable.just(<span class="number">1</span>, <span class="number">3</span>, <span class="number">5</span>, <span class="number">7</span>, <span class="number">9</span>);</span><br><span class="line">        Observable.zip(evens, odds, (v1, v2) -&gt; v1 + <span class="string">" + "</span> + v2 + <span class="string">" is: "</span> + (v1 + v2)).subscribe(System.out::println);</span><br><span class="line">        </span><br><span class="line">结果:</span><br><span class="line"></span><br><span class="line"><span class="number">2</span> + <span class="number">1</span> is: <span class="number">3</span></span><br><span class="line"><span class="number">4</span> + <span class="number">3</span> is: <span class="number">7</span></span><br><span class="line"><span class="number">6</span> + <span class="number">5</span> is: <span class="number">11</span></span><br><span class="line"><span class="number">8</span> + <span class="number">7</span> is: <span class="number">15</span></span><br><span class="line"><span class="number">10</span> + <span class="number">9</span> is: <span class="number">19</span></span><br></pre></td></tr></table></figure>
</p>
<h4 id="Error-Handling-Operators"><a href="#Error-Handling-Operators" class="headerlink" title="Error Handling Operators"></a>Error Handling Operators</h4><h5 id="Catch"><a href="#Catch" class="headerlink" title="Catch"></a>Catch</h5><blockquote>
<p>从错误中恢复，继续执行，示例</p>
</blockquote>
<h6 id="onErrorReturn"><a href="#onErrorReturn" class="headerlink" title="onErrorReturn"></a>onErrorReturn</h6><blockquote>
<p>出现错误时，返回一个特定的值，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).map(integer -&gt; integer / <span class="number">0</span>).onErrorReturn(throwable -&gt; <span class="number">0</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<h6 id="onErrorResumeNext-onExceptionResumeNext"><a href="#onErrorResumeNext-onExceptionResumeNext" class="headerlink" title="onErrorResumeNext, onExceptionResumeNext"></a>onErrorResumeNext, onExceptionResumeNext</h6><blockquote>
<p>出现错误，构建另一个消息源，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).map(integer -&gt; integer / <span class="number">0</span>).onErrorResumeNext(throwable -&gt; Observable.from(integers1)).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">0</span></span><br><span class="line">onNext value: -<span class="number">1</span></span><br><span class="line">onNext value: -<span class="number">2</span></span><br><span class="line">onNext value: -<span class="number">3</span></span><br><span class="line">onNext value: -<span class="number">4</span></span><br><span class="line">onNext value: -<span class="number">5</span></span><br><span class="line">onNext value: -<span class="number">6</span></span><br><span class="line">onNext value: -<span class="number">7</span></span><br><span class="line">onNext value: -<span class="number">8</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (done) &#123;</span><br><span class="line">        Exceptions.throwIfFatal(e);</span><br><span class="line">        RxJavaHooks.onError(e);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    done = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">        unsubscribe();</span><br><span class="line"></span><br><span class="line">        Subscriber&lt;T&gt; next = <span class="keyword">new</span> Subscriber&lt;T&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">                child.onNext(t);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                child.onError(e);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                child.onCompleted();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProducer</span><span class="params">(Producer producer)</span> </span>&#123;</span><br><span class="line">                pa.setProducer(producer);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">        serial.set(next);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">long</span> p = produced;</span><br><span class="line">        <span class="keyword">if</span> (p != <span class="number">0L</span>) &#123;</span><br><span class="line">            pa.produced(p);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Observable&lt;? extends T&gt; resume = resumeFunction.call(e);</span><br><span class="line"></span><br><span class="line">        resume.unsafeSubscribe(next);</span><br><span class="line">    &#125; <span class="keyword">catch</span> (Throwable e2) &#123;</span><br><span class="line">        Exceptions.throwOrReport(e2, child);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>出现错误，使用外部提供的方式产生新的消息源并发出</li>
</ul>
<h5 id="Retry"><a href="#Retry" class="headerlink" title="Retry"></a>Retry</h5><h6 id="retry"><a href="#retry" class="headerlink" title="retry"></a>retry</h6><blockquote>
<p>出现错误，重新订阅并重试，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).map(integer -&gt; &#123;</span><br><span class="line">    <span class="keyword">int</span> a = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">if</span> (integer == a) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"aa"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> integer;</span><br><span class="line">&#125;).retry(<span class="number">1</span>).subscribe(mSubscriber);</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li><code>retry</code>也可以提供选择器来决定是否重试</li>
</ul>
<h6 id="retryWhen"><a href="#retryWhen" class="headerlink" title="retryWhen"></a>retryWhen</h6><blockquote>
<p>捕获错误，生成第二个消息源,并监听此消息源，如果此消息源发出消息，则重新订阅源消息，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).map(integer -&gt; &#123;</span><br><span class="line">            <span class="keyword">int</span> a = <span class="number">5</span>;</span><br><span class="line">            <span class="keyword">if</span> (integer == a) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"aa"</span>);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">return</span> integer;</span><br><span class="line">        &#125;).retryWhen(observable -&gt; observable.zipWith(Observable.range(<span class="number">1</span>, <span class="number">3</span>), (n, i) -&gt; i).flatMap(i -&gt; &#123;</span><br><span class="line">            System.out.println(<span class="string">"delay retry by "</span> + i + <span class="string">" second(s)"</span>);</span><br><span class="line">            <span class="keyword">return</span> Observable.timer(i, TimeUnit.SECONDS);</span><br><span class="line">        &#125;)).toBlocking().forEach(System.out::println);</span><br></pre></td></tr></table></figure>
</p>
<h4 id="Observable-Utility-Operators"><a href="#Observable-Utility-Operators" class="headerlink" title="Observable Utility Operators"></a>Observable Utility Operators</h4><h5 id="Delay"><a href="#Delay" class="headerlink" title="Delay"></a>Delay</h5><blockquote>
<p>延迟发出消息，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).delay(<span class="number">5</span>, TimeUnit.SECONDS).toBlocking().forEach(System.out::println);</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(<span class="keyword">final</span> T t)</span> </span>&#123;</span><br><span class="line">    worker.schedule(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">            <span class="keyword">if</span> (!done) &#123;</span><br><span class="line">                child.onNext(t);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;, delay, unit);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>线程调度延时</li>
</ul>
<h5 id="Do"><a href="#Do" class="headerlink" title="Do"></a>Do</h5><blockquote>
<p>在可观察对象生命周期发生之前调用，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).doAfterTerminate(() -&gt; &#123;</span><br><span class="line">    System.out.println(<span class="string">"terminate"</span>);</span><br><span class="line">&#125;).subscribe(mSubscriber);</span><br></pre></td></tr></table></figure>
</p>
<h5 id="Materialize-Dematerialize"><a href="#Materialize-Dematerialize" class="headerlink" title="Materialize/Dematerialize"></a>Materialize/Dematerialize</h5><blockquote>
<p>对于发出的每个消息进行包装与拆包装</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).materialize().dematerialize().subscribe(mSubscriber);</span><br></pre></td></tr></table></figure>
</p>
<h5 id="ObserveOn"><a href="#ObserveOn" class="headerlink" title="ObserveOn"></a>ObserveOn</h5><blockquote>
<p>指定观察者在哪个线程观察结果</p>
</blockquote>
<ul>
<li>源码</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">ScalarSynchronousObservable.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Observable&lt;T&gt; <span class="title">scalarScheduleOn</span><span class="params">(<span class="keyword">final</span> Scheduler scheduler)</span> </span>&#123;</span><br><span class="line">    Func1&lt;Action0, Subscription&gt; onSchedule;</span><br><span class="line">    <span class="keyword">if</span> (scheduler <span class="keyword">instanceof</span> EventLoopsScheduler) &#123;</span><br><span class="line">        <span class="keyword">final</span> EventLoopsScheduler els = (EventLoopsScheduler) scheduler;</span><br><span class="line">        onSchedule = <span class="keyword">new</span> Func1&lt;Action0, Subscription&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Subscription <span class="title">call</span><span class="params">(Action0 a)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">return</span> els.scheduleDirect(a);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        onSchedule = <span class="keyword">new</span> Func1&lt;Action0, Subscription&gt;() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> Subscription <span class="title">call</span><span class="params">(<span class="keyword">final</span> Action0 a)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">final</span> Scheduler.Worker w = scheduler.createWorker();</span><br><span class="line">                w.schedule(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            a.call();</span><br><span class="line">                        &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                            w.unsubscribe();</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">                <span class="keyword">return</span> w;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> create(<span class="keyword">new</span> ScalarAsyncOnSubscribe&lt;T&gt;(t, onSchedule));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>区分<code>EventLoopsScheduler</code>和其他调度器。如果是<code>EventLoopsScheduler</code>直接调度，否则创建调度器,由调度器运行接收到的消息。解除调度器订阅</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">OperatorObserveOn.java</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> Subscriber&lt;? <span class="keyword">super</span> T&gt; call(Subscriber&lt;? <span class="keyword">super</span> T&gt; child) &#123;</span><br><span class="line">    <span class="keyword">if</span> (scheduler <span class="keyword">instanceof</span> ImmediateScheduler) &#123;</span><br><span class="line">        <span class="comment">// avoid overhead, execute directly</span></span><br><span class="line">        <span class="keyword">return</span> child;</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (scheduler <span class="keyword">instanceof</span> TrampolineScheduler) &#123;</span><br><span class="line">        <span class="comment">// avoid overhead, execute directly</span></span><br><span class="line">        <span class="keyword">return</span> child;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        ObserveOnSubscriber&lt;T&gt; parent = <span class="keyword">new</span> ObserveOnSubscriber&lt;T&gt;(scheduler, child, delayError, bufferSize);</span><br><span class="line">        parent.init();</span><br><span class="line">        <span class="keyword">return</span> parent;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>如果调度器是<code>ImmediateScheduler(即时调度器)</code>或者<code>TrampolineScheduler(串行调度器)</code>则立即执行。否则创建<code>ObserveOnSubscriber</code></li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">ObserveOnSubscriber.<span class="function">java</span><br><span class="line"></span><br><span class="line"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">schedule</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">if</span> (counter.getAndIncrement() == <span class="number">0</span>) &#123;</span><br><span class="line">        recursiveScheduler.schedule(<span class="keyword">this</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">while</span> (requestAmount != currentEmission) &#123;</span><br><span class="line">    <span class="keyword">boolean</span> done = finished;</span><br><span class="line">    Object v = q.poll();</span><br><span class="line">    <span class="keyword">boolean</span> empty = v == <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (checkTerminated(done, empty, localChild, q)) &#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (empty) &#123;</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    localChild.onNext(NotificationLite.&lt;T&gt;getValue(v));</span><br><span class="line"></span><br><span class="line">    currentEmission++;</span><br><span class="line">    <span class="keyword">if</span> (currentEmission == limit) &#123;</span><br><span class="line">        requestAmount = BackpressureUtils.produced(requested, currentEmission);</span><br><span class="line">        request(currentEmission);</span><br><span class="line">        currentEmission = <span class="number">0L</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>其中有个队列(<code>SpscAtomicArrayQueue</code>)，用于接收消息，开始循环从队列中取出消息，如果发送的消息数量和请求消息的数量一致，表示此次事件发送结束</li>
</ul>
<h5 id="Serialize"><a href="#Serialize" class="headerlink" title="Serialize"></a>Serialize</h5><blockquote>
<p>强制串行发送消息</p>
</blockquote>
<h5 id="SubscribeOn"><a href="#SubscribeOn" class="headerlink" title="SubscribeOn"></a>SubscribeOn</h5><blockquote>
<p>指定可观察对象在哪个线程上执行</p>
</blockquote>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">inner.schedule(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> Thread t = Thread.currentThread();</span><br><span class="line"></span><br><span class="line">        Subscriber&lt;T&gt; s = <span class="keyword">new</span> Subscriber&lt;T&gt;(subscriber) &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T t)</span> </span>&#123;</span><br><span class="line">                subscriber.onNext(t);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onError</span><span class="params">(Throwable e)</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    subscriber.onError(e);</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    inner.unsubscribe();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCompleted</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    subscriber.onCompleted();</span><br><span class="line">                &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                    inner.unsubscribe();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setProducer</span><span class="params">(<span class="keyword">final</span> Producer p)</span> </span>&#123;</span><br><span class="line">                subscriber.setProducer(<span class="keyword">new</span> Producer() &#123;</span><br><span class="line">                    <span class="meta">@Override</span></span><br><span class="line">                    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">request</span><span class="params">(<span class="keyword">final</span> <span class="keyword">long</span> n)</span> </span>&#123;</span><br><span class="line">                        <span class="keyword">if</span> (t == Thread.currentThread()) &#123;</span><br><span class="line">                            p.request(n);</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            inner.schedule(<span class="keyword">new</span> Action0() &#123;</span><br><span class="line">                                <span class="meta">@Override</span></span><br><span class="line">                                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">()</span> </span>&#123;</span><br><span class="line">                                    p.request(n);</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;);</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        source.unsafeSubscribe(s);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>开启线程调度，从当前线程中发出消息到下一级订阅者</li>
</ul>
<h5 id="TimeInterval"><a href="#TimeInterval" class="headerlink" title="TimeInterval"></a>TimeInterval</h5><blockquote>
<p>将源消息源发出的消息转换成表示消息与消息直接的时间间隔,示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).timeInterval().subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">2</span>, value=<span class="number">0</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">1</span>, value=<span class="number">1</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">0</span>, value=<span class="number">2</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">0</span>, value=<span class="number">3</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">0</span>, value=<span class="number">4</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">0</span>, value=<span class="number">5</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">0</span>, value=<span class="number">6</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">0</span>, value=<span class="number">7</span>]</span><br><span class="line">onNext value: TimeInterval [intervalInMilliseconds=<span class="number">0</span>, value=<span class="number">8</span>]</span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>源码分析</li>
</ul>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onNext</span><span class="params">(T args)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">long</span> nowTimestamp = scheduler.now();</span><br><span class="line">    subscriber.onNext(<span class="keyword">new</span> TimeInterval&lt;T&gt;(nowTimestamp - lastTimestamp, args));</span><br><span class="line">    lastTimestamp = nowTimestamp;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>当前时间减去上次接收到消息的时间，封装成<code>TimeIntegerval</code></li>
</ul>
<h5 id="TimeOut"><a href="#TimeOut" class="headerlink" title="TimeOut"></a>TimeOut</h5><blockquote>
<p>如果在一定时间内没有发出消息，发出<code>error</code>通知</p>
</blockquote>
<h5 id="Timestamp"><a href="#Timestamp" class="headerlink" title="Timestamp"></a>Timestamp</h5><blockquote>
<p>给每个发出的消息带上时间戳,示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).timestamp().subscribe(mSubscriber);</span><br></pre></td></tr></table></figure>
</p>
<h5 id="Using"><a href="#Using" class="headerlink" title="Using"></a>Using</h5><blockquote>
<p>创建可分配的资源，其与可观察对象具有一样的生命周期</p>
</blockquote>
<h4 id="Conditional-and-Boolean-Operators"><a href="#Conditional-and-Boolean-Operators" class="headerlink" title="Conditional and Boolean Operators"></a>Conditional and Boolean Operators</h4><h5 id="All"><a href="#All" class="headerlink" title="All"></a>All</h5><blockquote>
<p>规定是否所有的消息发出，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).all(integer -&gt; integer &lt; <span class="number">5</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="keyword">false</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<h5 id="Amb"><a href="#Amb" class="headerlink" title="Amb"></a>Amb</h5><blockquote>
<p>只发送多个消息源中最先产生消息的消息源，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Observable.amb(Observable.from(integers).delay(<span class="number">2</span>, TimeUnit.SECONDS), Observable.from(integers1).delay(<span class="number">1</span>, TimeUnit.SECONDS))</span><br><span class="line">                  .toBlocking()</span><br><span class="line">                  .forEach(System.out::println);</span><br><span class="line">                  </span><br><span class="line">结果:</span><br><span class="line"><span class="number">0</span></span><br><span class="line">-<span class="number">1</span></span><br><span class="line">-<span class="number">2</span></span><br><span class="line">-<span class="number">3</span></span><br><span class="line">-<span class="number">4</span></span><br><span class="line">-<span class="number">5</span></span><br><span class="line">-<span class="number">6</span></span><br><span class="line">-<span class="number">7</span></span><br><span class="line">-<span class="number">8</span></span><br></pre></td></tr></table></figure>
</p>
<h5 id="Contain"><a href="#Contain" class="headerlink" title="Contain"></a>Contain</h5><blockquote>
<p>发出的消息是否包含某消息，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).contains(<span class="number">1</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="keyword">true</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<h5 id="DefaultIfEmpty"><a href="#DefaultIfEmpty" class="headerlink" title="DefaultIfEmpty"></a>DefaultIfEmpty</h5><blockquote>
<p>如果没有发出任何消息，发出默认消息,示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.empty().defaultIfEmpty(<span class="number">11</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="number">11</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<h5 id="SequenceEqual"><a href="#SequenceEqual" class="headerlink" title="SequenceEqual"></a>SequenceEqual</h5><blockquote>
<p>两个消息源是否发出相同的消息,示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Observable.sequenceEqual(Observable.from(integers), Observable.from(integers)).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onNext value: <span class="keyword">true</span></span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<h5 id="SkipUntil-TakeUntil"><a href="#SkipUntil-TakeUntil" class="headerlink" title="SkipUntil, TakeUntil"></a>SkipUntil, TakeUntil</h5><blockquote>
<p>丢弃/发送第一个消息源在第二个消息源发出消息之前发出的消息，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).skipUntil(Observable.from(integers1).delay(<span class="number">1</span>, TimeUnit.SECONDS)).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<h5 id="SkipWhile-TakeWhile"><a href="#SkipWhile-TakeWhile" class="headerlink" title="SkipWhile, TakeWhile"></a>SkipWhile, TakeWhile</h5><blockquote>
<p>丢弃/发送消息直到某个条件变成false，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).skipWhile(integer -&gt; integer &gt;= <span class="number">0</span>).subscribe(mSubscriber);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line">onCompleted</span><br></pre></td></tr></table></figure>
</p>
<h4 id="Mathematical-and-Aggregate-Operators"><a href="#Mathematical-and-Aggregate-Operators" class="headerlink" title="Mathematical and Aggregate Operators"></a>Mathematical and Aggregate Operators</h4><h5 id="Average"><a href="#Average" class="headerlink" title="Average"></a>Average</h5><blockquote>
<p>发出消息的平均值，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">MathObservable.from(Observable.from(integers)).averageInteger(integer -&gt; integer).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">结果：</span><br><span class="line"><span class="number">4</span></span><br></pre></td></tr></table></figure>
</p>
<h5 id="Concat"><a href="#Concat" class="headerlink" title="Concat"></a>Concat</h5><blockquote>
<p>拼接多个消息源，按顺序发送消息，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Observable.concat(Observable.from(integers), Observable.from(integers1)).forEach(System.out::println);</span><br></pre></td></tr></table></figure>
</p>
<h5 id="Count"><a href="#Count" class="headerlink" title="Count"></a>Count</h5><blockquote>
<p>统计发出消息的数量，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assertEquals(Integer.valueOf(integers.length), Observable.from(integers).count().toBlocking().single());</span><br></pre></td></tr></table></figure>
</p>
<h5 id="Max-Min"><a href="#Max-Min" class="headerlink" title="Max/Min"></a>Max/Min</h5><blockquote>
<p>获取消息中最大/最小值，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">assertEquals(integers[integers.length - <span class="number">1</span>], MathObservable.from(Observable.from(integers)).max((o1, o2) -&gt; o1 - o2).toBlocking().single());</span><br></pre></td></tr></table></figure>
</p>
<h5 id="Reduce-Sum"><a href="#Reduce-Sum" class="headerlink" title="Reduce, Sum"></a>Reduce, Sum</h5><blockquote>
<p>对每个发出的消息做操作，发送最终的值，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Observable.from(integers).reduce((integer, integer2) -&gt; integer + integer2).forEach(System.out::println);</span><br><span class="line"></span><br><span class="line">结果:</span><br><span class="line"><span class="number">36</span></span><br></pre></td></tr></table></figure>
</p>
<h4 id="Backpressure-Operators"><a href="#Backpressure-Operators" class="headerlink" title="Backpressure Operators"></a>Backpressure Operators</h4><ul>
<li>Buffer, Sample, Debounce, Window</li>
</ul>
<h4 id="Connectable-Observable-Operators"><a href="#Connectable-Observable-Operators" class="headerlink" title="Connectable Observable Operators"></a>Connectable Observable Operators</h4><h5 id="Connect"><a href="#Connect" class="headerlink" title="Connect"></a>Connect</h5><blockquote>
<p>连接<code>Observable</code>和<code>Subscribers</code>。可以指定连接几个<code>Subscriber</code>。只有当所有的<code>Subscriber</code>都订阅了才开始发送消息。示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> AtomicInteger run = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"></span><br><span class="line">   <span class="keyword">final</span> ConnectableObservable&lt;Integer&gt; co = Observable.defer(() -&gt; Observable.just(run.incrementAndGet())).publish();</span><br><span class="line"></span><br><span class="line"><span class="comment">//自动连接，生成可观察对象</span></span><br><span class="line">   <span class="keyword">final</span> Observable&lt;Integer&gt; source = co.autoConnect();</span><br><span class="line"></span><br><span class="line">   assertEquals(<span class="number">0</span>, run.get());</span><br><span class="line"></span><br><span class="line">   TestSubscriber&lt;Integer&gt; ts1 = TestSubscriber.create();</span><br><span class="line">   <span class="comment">//订阅了一次</span></span><br><span class="line">   source.subscribe(ts1);</span><br><span class="line"></span><br><span class="line">   ts1.assertCompleted();</span><br><span class="line">   ts1.assertNoErrors();</span><br><span class="line">   ts1.assertValue(<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">   assertEquals(<span class="number">1</span>, run.get());</span><br><span class="line"></span><br><span class="line">   TestSubscriber&lt;Integer&gt; ts2 = TestSubscriber.create();</span><br><span class="line">   <span class="comment">//第二次订阅，这是无效的，因为默认只指定了一次订阅</span></span><br><span class="line">   source.subscribe(ts2);</span><br><span class="line"></span><br><span class="line">   ts2.assertNotCompleted();</span><br><span class="line">   ts2.assertNoErrors();</span><br><span class="line">   ts2.assertNoValues();</span><br><span class="line"></span><br><span class="line">   assertEquals(<span class="number">1</span>, run.get());</span><br></pre></td></tr></table></figure>
</p>
<h5 id="Publish"><a href="#Publish" class="headerlink" title="Publish"></a>Publish</h5><blockquote>
<p>将普通<code>Observable</code>转换成<code>ConnectableObservable</code>，示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> AtomicInteger counter = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">ConnectableObservable&lt;String&gt; o = Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> String&gt; observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            counter.incrementAndGet();</span><br><span class="line">            observer.onNext(<span class="string">"one"</span>);</span><br><span class="line">            observer.onCompleted();</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).publish();</span><br><span class="line"></span><br><span class="line"><span class="keyword">final</span> CountDownLatch countDownLatch = <span class="keyword">new</span> CountDownLatch(<span class="number">2</span>);</span><br><span class="line">o.subscribe(v -&gt; &#123;</span><br><span class="line">    assertEquals(<span class="string">"one"</span>, v);</span><br><span class="line">    countDownLatch.countDown();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// subscribe again</span></span><br><span class="line">o.subscribe(v -&gt; &#123;</span><br><span class="line">    assertEquals(<span class="string">"one"</span>, v);</span><br><span class="line">    countDownLatch.countDown();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//连接，才能收到消息</span></span><br><span class="line"><span class="keyword">final</span> Subscription subscription = o.connect();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!countDownLatch.await(<span class="number">1000</span>, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">        fail(<span class="string">"subscriptions did not receive values"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    assertEquals(<span class="number">1</span>, counter.get());</span><br><span class="line">&#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">    subscription.unsubscribe();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</p>
<h5 id="RefCount"><a href="#RefCount" class="headerlink" title="RefCount"></a>RefCount</h5><blockquote>
<p>让<code>ConnectTableObservable</code>表现像普通<code>Observable</code>。示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> AtomicInteger subscribeCount = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"><span class="keyword">final</span> AtomicInteger nextCount = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"><span class="keyword">final</span> Observable&lt;Integer&gt; observable = Observable.from(integers)</span><br><span class="line">                                                 .doOnSubscribe(subscribeCount::incrementAndGet)</span><br><span class="line">                                                 .doOnNext(l -&gt; nextCount.incrementAndGet())</span><br><span class="line">                                                 .publish()</span><br><span class="line">                                                 .refCount();</span><br><span class="line"><span class="keyword">final</span> AtomicInteger receivedCount = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line"><span class="comment">//订阅一次,doOnNext会执行</span></span><br><span class="line"><span class="keyword">final</span> Subscription s1 = observable.subscribe(l -&gt; receivedCount.incrementAndGet());</span><br><span class="line"><span class="comment">//订阅第二次, doOnNext会执行</span></span><br><span class="line"><span class="keyword">final</span> Subscription s2 = observable.subscribe();</span><br><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    Thread.sleep(<span class="number">50</span>);</span><br><span class="line">&#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span><br><span class="line">&#125;</span><br><span class="line">s2.unsubscribe();</span><br><span class="line">s1.unsubscribe();</span><br><span class="line"></span><br><span class="line">System.out.println(<span class="string">"onNext Count: "</span> + nextCount.get());</span><br><span class="line"></span><br><span class="line">assertEquals(nextCount.get(), receivedCount.get() * <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">assertEquals(<span class="number">2</span>, subscribeCount.get());</span><br></pre></td></tr></table></figure>
</p>
<ul>
<li>普通<code>Observable</code>和<code>ConnectTableObservable</code>区别在于，普通的<code>Observable</code>只要订阅，就会发送消息，而<code>ConnectTableObservable</code>会连接几个订阅者，如连接1各订阅者，但是订阅了两次，那么后面一次是不会执行的。</li>
</ul>
<h5 id="Replay-Cache"><a href="#Replay-Cache" class="headerlink" title="Replay, Cache"></a>Replay, Cache</h5><blockquote>
<p>确保所有的观察者看到相同的消息时序，虽然它们订阅的时候，消息源可能已经开始发送消息了。示例</p>
</blockquote>
<p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> AtomicInteger counter = <span class="keyword">new</span> AtomicInteger();</span><br><span class="line">Observable&lt;String&gt; o = Observable.create(<span class="keyword">new</span> Observable.OnSubscribe&lt;String&gt;() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">call</span><span class="params">(<span class="keyword">final</span> Subscriber&lt;? <span class="keyword">super</span> String&gt; observer)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">new</span> Thread(() -&gt; &#123;</span><br><span class="line">            counter.incrementAndGet();</span><br><span class="line">            System.out.println(<span class="string">"published observable being executed"</span>);</span><br><span class="line">            observer.onNext(<span class="string">"one"</span>);</span><br><span class="line">            observer.onCompleted();</span><br><span class="line">        &#125;).start();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;).replay().autoConnect();</span><br><span class="line"></span><br><span class="line"><span class="comment">// we then expect the following 2 subscriptions to get that same value</span></span><br><span class="line"><span class="keyword">final</span> CountDownLatch latch = <span class="keyword">new</span> CountDownLatch(<span class="number">2</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// subscribe once</span></span><br><span class="line">o.subscribe(v -&gt; &#123;</span><br><span class="line">    assertEquals(<span class="string">"one"</span>, v);</span><br><span class="line">    System.out.println(<span class="string">"v: "</span> + v);</span><br><span class="line">    latch.countDown();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// subscribe again</span></span><br><span class="line">o.subscribe(v -&gt; &#123;</span><br><span class="line">    assertEquals(<span class="string">"one"</span>, v);</span><br><span class="line">    System.out.println(<span class="string">"v: "</span> + v);</span><br><span class="line">    latch.countDown();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> (!latch.await(<span class="number">1000</span>, TimeUnit.MILLISECONDS)) &#123;</span><br><span class="line">    fail(<span class="string">"subscriptions did not receive values"</span>);</span><br><span class="line">&#125;</span><br><span class="line">assertEquals(<span class="number">1</span>, counter.get());</span><br></pre></td></tr></table></figure>
</p>
<p><a href="http://reactivex.io/documentation/operators.html" target="_blank" rel="external">ref</a></p>
<h4 id="Custom-Operator"><a href="#Custom-Operator" class="headerlink" title="Custom Operator)"></a><a href="https://github.com/ReactiveX/RxJava/wiki/Implementing-custom-operators-(draft" target="_blank" rel="external">Custom Operator</a>)</h4><h4 id="流程"><a href="#流程" class="headerlink" title="流程"></a>流程</h4><h5 id="基本流程图"><a href="#基本流程图" class="headerlink" title="基本流程图"></a>基本流程图</h5><p><img src="./Observable.png" alt="Observable"></p>
<ul>
<li>流程分析:<ol>
<li>通过类方法<code>create</code>构造<code>Observable</code>对象。<code>create</code>内部使用<code>RxJavaHook</code>方法来创建<code>OnSubscribe</code>。</li>
<li>调用<code>subscribe(Subscriber)</code>方法，内部会将<code>Subscriber</code>转换成<code>SafeSubscriber</code>。然后调用<code>RxJavaHooks.onObservableStart(Observable, OnSubscribe).call(subscriber)</code>。这其实就是使用第一步设置的<code>OnSubscribe</code>调用<code>call</code>。上诉流程中<code>RxJavaHooks</code>其实就是对整个流程的一些关键步骤做<code>hook</code>以便可以由后续操作。这是最基本的<code>RxJava</code>流程</li>
</ol>
</li>
</ul>
<h5 id="通用流程图"><a href="#通用流程图" class="headerlink" title="通用流程图"></a>通用流程图</h5><p><img src="./Operator.png" alt="Operator"></p>
<ul>
<li>流程分析<ol>
<li>当调用<code>subscribe</code>时会调用离它最近的<code>OnSubscribe</code>，如果是<code>Operator</code>的话。那就会调用最近的<code>OnSubscribeLift</code>的<code>call</code>。这时<code>RxJavaHooks</code>会调用<code>onObserveLift</code>的<code>call</code>产生新的订阅者。父类<code>OnSubscribe</code>会调用这个新的订阅者，并通过<code>call</code>将这个订阅者传给父类<code>OnSubscribe</code>中，在其中给子订阅者设置生产者<code>setProducer</code>，这时生产者会调用<code>request</code>。然后会在这里将消息发给子订阅者。</li>
<li>线程调度: <code>OperatorSubscribeOn</code>,将每个生产者产生的所有的数据单独放到一个<code>Runnable</code>当中运行。 <code>OperatorObserveOn</code>则是使用队列。来一个消息往队列里面插入，并要求队列开始执行。典型的多生产者但但消费者模型。<code>事件产生</code>使用<code>subscribeOn</code>来切换线程。而且只有第一个<code>subscribeOn</code>会生效。而事件加工和消费使用<code>observeonOn</code>来切换线程。影响的是后续的<code>Subscriber</code>。</li>
</ol>
</li>
</ul>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/12/31/2016总结/" rel="next" title="2016总结">
                <i class="fa fa-chevron-left"></i> 2016总结
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            Inhaltsverzeichnis
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            Übersicht
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/upload_file/tmp.jpg"
               alt="Binea" />
          <p class="site-author-name" itemprop="name">Binea</p>
          <p class="site-description motion-element" itemprop="description"></p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">26</span>
              <span class="site-state-item-name">Artikel</span>
            </a>
          </div>

          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">12</span>
                <span class="site-state-item-name">Tags</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-3"><a class="nav-link" href="#Operators"><span class="nav-number">1.</span> <span class="nav-text">Operators</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Creating-Observables"><span class="nav-number">1.1.</span> <span class="nav-text">Creating Observables</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#create-OnSubscribe"><span class="nav-number">1.1.1.</span> <span class="nav-text">create(OnSubscribe)</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#defer"><span class="nav-number">1.1.2.</span> <span class="nav-text">defer</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Empty-Never-Throw"><span class="nav-number">1.1.3.</span> <span class="nav-text">Empty Never Throw</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#From"><span class="nav-number">1.1.4.</span> <span class="nav-text">From</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Interval"><span class="nav-number">1.1.5.</span> <span class="nav-text">Interval</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Just"><span class="nav-number">1.1.6.</span> <span class="nav-text">Just</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Range"><span class="nav-number">1.1.7.</span> <span class="nav-text">Range</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Repeat"><span class="nav-number">1.1.8.</span> <span class="nav-text">Repeat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Timer"><span class="nav-number">1.1.9.</span> <span class="nav-text">Timer</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Transforming-Observables"><span class="nav-number">1.2.</span> <span class="nav-text">Transforming Observables</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Buffer"><span class="nav-number">1.2.1.</span> <span class="nav-text">Buffer</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#buffer-int-count-int-skip"><span class="nav-number">1.2.1.1.</span> <span class="nav-text">buffer(int count, int skip)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#buffer-Func0"><span class="nav-number">1.2.1.2.</span> <span class="nav-text">buffer(Func0)</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#buffer-long-timespan-long-timeshift-TimeUnit-unit"><span class="nav-number">1.2.1.3.</span> <span class="nav-text">buffer(long timespan, long timeshift, TimeUnit unit)</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#FlatMap"><span class="nav-number">1.2.2.</span> <span class="nav-text">FlatMap</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#GroupBy"><span class="nav-number">1.2.3.</span> <span class="nav-text">GroupBy</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Map"><span class="nav-number">1.2.4.</span> <span class="nav-text">Map</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Scan"><span class="nav-number">1.2.5.</span> <span class="nav-text">Scan</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Window"><span class="nav-number">1.2.6.</span> <span class="nav-text">Window</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Filtering-Observables"><span class="nav-number">1.3.</span> <span class="nav-text">Filtering Observables</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Debounce"><span class="nav-number">1.3.1.</span> <span class="nav-text">Debounce</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Distinct"><span class="nav-number">1.3.2.</span> <span class="nav-text">Distinct</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ElementAt"><span class="nav-number">1.3.3.</span> <span class="nav-text">ElementAt</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Filter"><span class="nav-number">1.3.4.</span> <span class="nav-text">Filter</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#first"><span class="nav-number">1.3.5.</span> <span class="nav-text">first</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#IgnoreElements"><span class="nav-number">1.3.6.</span> <span class="nav-text">IgnoreElements</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#last"><span class="nav-number">1.3.7.</span> <span class="nav-text">last</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Sample"><span class="nav-number">1.3.8.</span> <span class="nav-text">Sample</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#skip"><span class="nav-number">1.3.9.</span> <span class="nav-text">skip</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#skipLast"><span class="nav-number">1.3.10.</span> <span class="nav-text">skipLast</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Take-TakeLast"><span class="nav-number">1.3.11.</span> <span class="nav-text">Take, TakeLast</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Combining-Observable"><span class="nav-number">1.4.</span> <span class="nav-text">Combining Observable</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#And-Then-When"><span class="nav-number">1.4.1.</span> <span class="nav-text">And/Then/When</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#CombineLast"><span class="nav-number">1.4.2.</span> <span class="nav-text">CombineLast</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Join"><span class="nav-number">1.4.3.</span> <span class="nav-text">Join</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Merge"><span class="nav-number">1.4.4.</span> <span class="nav-text">Merge</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#StartWith"><span class="nav-number">1.4.5.</span> <span class="nav-text">StartWith</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Switch"><span class="nav-number">1.4.6.</span> <span class="nav-text">Switch</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#zip"><span class="nav-number">1.4.7.</span> <span class="nav-text">zip</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Error-Handling-Operators"><span class="nav-number">1.5.</span> <span class="nav-text">Error Handling Operators</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Catch"><span class="nav-number">1.5.1.</span> <span class="nav-text">Catch</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#onErrorReturn"><span class="nav-number">1.5.1.1.</span> <span class="nav-text">onErrorReturn</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#onErrorResumeNext-onExceptionResumeNext"><span class="nav-number">1.5.1.2.</span> <span class="nav-text">onErrorResumeNext, onExceptionResumeNext</span></a></li></ol></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Retry"><span class="nav-number">1.5.2.</span> <span class="nav-text">Retry</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#retry"><span class="nav-number">1.5.2.1.</span> <span class="nav-text">retry</span></a></li><li class="nav-item nav-level-6"><a class="nav-link" href="#retryWhen"><span class="nav-number">1.5.2.2.</span> <span class="nav-text">retryWhen</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Observable-Utility-Operators"><span class="nav-number">1.6.</span> <span class="nav-text">Observable Utility Operators</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Delay"><span class="nav-number">1.6.1.</span> <span class="nav-text">Delay</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Do"><span class="nav-number">1.6.2.</span> <span class="nav-text">Do</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Materialize-Dematerialize"><span class="nav-number">1.6.3.</span> <span class="nav-text">Materialize/Dematerialize</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#ObserveOn"><span class="nav-number">1.6.4.</span> <span class="nav-text">ObserveOn</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Serialize"><span class="nav-number">1.6.5.</span> <span class="nav-text">Serialize</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SubscribeOn"><span class="nav-number">1.6.6.</span> <span class="nav-text">SubscribeOn</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TimeInterval"><span class="nav-number">1.6.7.</span> <span class="nav-text">TimeInterval</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#TimeOut"><span class="nav-number">1.6.8.</span> <span class="nav-text">TimeOut</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Timestamp"><span class="nav-number">1.6.9.</span> <span class="nav-text">Timestamp</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Using"><span class="nav-number">1.6.10.</span> <span class="nav-text">Using</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Conditional-and-Boolean-Operators"><span class="nav-number">1.7.</span> <span class="nav-text">Conditional and Boolean Operators</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#All"><span class="nav-number">1.7.1.</span> <span class="nav-text">All</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Amb"><span class="nav-number">1.7.2.</span> <span class="nav-text">Amb</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Contain"><span class="nav-number">1.7.3.</span> <span class="nav-text">Contain</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#DefaultIfEmpty"><span class="nav-number">1.7.4.</span> <span class="nav-text">DefaultIfEmpty</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SequenceEqual"><span class="nav-number">1.7.5.</span> <span class="nav-text">SequenceEqual</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SkipUntil-TakeUntil"><span class="nav-number">1.7.6.</span> <span class="nav-text">SkipUntil, TakeUntil</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#SkipWhile-TakeWhile"><span class="nav-number">1.7.7.</span> <span class="nav-text">SkipWhile, TakeWhile</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Mathematical-and-Aggregate-Operators"><span class="nav-number">1.8.</span> <span class="nav-text">Mathematical and Aggregate Operators</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Average"><span class="nav-number">1.8.1.</span> <span class="nav-text">Average</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Concat"><span class="nav-number">1.8.2.</span> <span class="nav-text">Concat</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Count"><span class="nav-number">1.8.3.</span> <span class="nav-text">Count</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Max-Min"><span class="nav-number">1.8.4.</span> <span class="nav-text">Max/Min</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Reduce-Sum"><span class="nav-number">1.8.5.</span> <span class="nav-text">Reduce, Sum</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Backpressure-Operators"><span class="nav-number">1.9.</span> <span class="nav-text">Backpressure Operators</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Connectable-Observable-Operators"><span class="nav-number">1.10.</span> <span class="nav-text">Connectable Observable Operators</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Connect"><span class="nav-number">1.10.1.</span> <span class="nav-text">Connect</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Publish"><span class="nav-number">1.10.2.</span> <span class="nav-text">Publish</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#RefCount"><span class="nav-number">1.10.3.</span> <span class="nav-text">RefCount</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Replay-Cache"><span class="nav-number">1.10.4.</span> <span class="nav-text">Replay, Cache</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Custom-Operator"><span class="nav-number">1.11.</span> <span class="nav-text">Custom Operator)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#流程"><span class="nav-number">1.12.</span> <span class="nav-text">流程</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#基本流程图"><span class="nav-number">1.12.1.</span> <span class="nav-text">基本流程图</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#通用流程图"><span class="nav-number">1.12.2.</span> <span class="nav-text">通用流程图</span></a></li></ol></li></ol></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Binea</span>
</div>

<div class="powered-by">
  Erstellt mit  <a class="theme-link" href="https://hexo.io">Hexo</a>
</div>

<div class="theme-info">
  Theme -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.2"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.2"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  



  




  
  

  

  

  

  


</body>
</html>
